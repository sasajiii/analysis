<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—èˆ—åˆ†æã‚¢ãƒ—ãƒª</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1800px;margin:0 auto;background:white;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,0.1);overflow:hidden}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center}.header h1{font-size:2rem;margin-bottom:10px}.header p{opacity:0.9}.content{padding:30px}.upload-area{background:#f8fafc;border:2px dashed #d1d5db;border-radius:12px;padding:40px;text-align:center;margin-bottom:30px;transition:all 0.3s ease}.upload-area:hover{border-color:#667eea;background:#f0f9ff}.upload-icon{font-size:3rem;margin-bottom:20px}.upload-area h3{margin-bottom:10px;color:#1f2937}.upload-area p{color:#64748b;margin-bottom:20px}.btn{background:#10b981;color:white;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;margin:0 5px;font-size:1rem}.btn:hover{background:#059669;transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,0.3)}.btn-secondary{background:#667eea}.btn-secondary:hover{background:#5568d3;box-shadow:0 4px 12px rgba(102,126,234,0.3)}.tabs{display:flex;background:#f8fafc;border-bottom:2px solid #e2e8f0;margin-bottom:20px}.tab{flex:1;padding:15px 20px;background:none;border:none;cursor:pointer;font-weight:600;font-size:1rem;color:#64748b;transition:all 0.2s}.tab:hover{background:#f1f5f9}.tab.active{background:white;color:#667eea;border-bottom:3px solid #667eea}.tab-content{display:none}.tab-content.active{display:block}.filters{background:#f8fafc;padding:20px;border-radius:12px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}.filter-group{display:flex;flex-direction:column}.filter-label{font-weight:600;margin-bottom:5px;color:#374151;font-size:0.9rem}.filter-control{padding:10px 12px;border:1px solid #d1d5db;border-radius:6px;background:white;font-size:0.95rem;transition:border-color 0.2s}.filter-control:focus{outline:none;border-color:#667eea}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin:20px 0}.stat-card{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);padding:25px;border-radius:12px;text-align:center;transition:transform 0.2s}.stat-card:hover{transform:translateY(-2px)}.stat-number{font-size:2.5rem;font-weight:bold;margin-bottom:8px}.stat-label{color:#64748b;font-size:0.9rem}.period-info{text-align:center;margin-bottom:20px;color:#64748b;font-weight:600;font-size:1.1rem}.rankings{display:grid;grid-template-columns:1fr 1fr;gap:20px}.ranking-section{background:#f8fafc;padding:20px;border-radius:12px;max-height:500px;overflow-y:auto}.ranking-section::-webkit-scrollbar{width:8px}.ranking-section::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}.ranking-title{font-weight:bold;font-size:1.2rem;margin-bottom:15px;text-align:center;padding-bottom:10px;border-bottom:2px solid #e2e8f0}.ranking-title.up{color:#10b981}.ranking-title.down{color:#ef4444}.ranking-item{background:white;padding:15px;margin-bottom:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:transform 0.2s}.ranking-item:hover{transform:translateX(5px)}.ranking-item.up{border-left:4px solid #10b981}.ranking-item.down{border-left:4px solid #ef4444}.store-name{font-weight:600;color:#1f2937;margin-bottom:5px}.store-details{font-size:0.85rem;color:#64748b;line-height:1.5}.score-change{font-weight:bold;font-size:1.3rem;padding:8px 16px;border-radius:6px}.score-change.positive{color:#10b981;background:#d1fae5}.score-change.negative{color:#ef4444;background:#fee2e2}.canvas-container{position:relative;width:100%;height:600px;margin:20px 0;background:white;border:1px solid #e2e8f0;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}.legend{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:15px;max-height:200px;overflow-y:auto}.legend::-webkit-scrollbar{height:8px}.legend::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}.legend-item{display:flex;align-items:center;gap:8px;font-size:0.85rem;padding:8px 12px;background:#f8fafc;border-radius:6px;transition:background 0.2s}.legend-item:hover{background:#e2e8f0}.legend-color{width:20px;height:3px;border-radius:2px;flex-shrink:0}.hidden{display:none}.empty-state{text-align:center;color:#64748b;padding:40px;font-size:1.1rem}@media (max-width:768px){.rankings{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ“Š åº—èˆ—åˆ†æã‚¢ãƒ—ãƒª</h1>
<p>ã‚¸ãƒ£ãƒ³ãƒ«å€‹åˆ¥é¸æŠãƒ»ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºãƒ»æ€¥ä¸Šæ˜‡æ€¥é™ä¸‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾å¿œ</p>
</div>
<div class="content">
<div class="upload-area">
<div class="upload-icon">ğŸ“</div>
<h3>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
<p>åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
<input type="file" id="fileInput" accept=".csv" style="display:none;">
<button class="btn" onclick="document.getElementById('fileInput').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
<button class="btn btn-secondary" onclick="loadSampleData()">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
</div>
<div id="results" class="hidden">
<div class="tabs">
<button class="tab active" onclick="switchTab('ranking')">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ</button>
<button class="tab" onclick="switchTab('graph')">ğŸ“ˆ ã‚°ãƒ©ãƒ•åˆ†æ</button>
<button class="tab" onclick="switchTab('spike')">âš¡ æ€¥ä¸Šæ˜‡ãƒ»æ€¥é™ä¸‹</button>
</div>
<div id="ranking-content" class="tab-content active">
<div class="filters">
<div class="filter-group"><label class="filter-label">åº—åã§æ¤œç´¢</label><input type="text" class="filter-control" id="searchBox" placeholder="åº—åã‚’å…¥åŠ›..." oninput="applyFilters()"></div>
<div class="filter-group"><label class="filter-label">çœŒ</label><select class="filter-control" id="prefectureSelect" onchange="applyFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ä¾¡æ ¼å¸¯</label><select class="filter-control" id="priceSelect" onchange="applyFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ã‚¸ãƒ£ãƒ³ãƒ«</label><select class="filter-control" id="genreSelect" onchange="applyFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">é–‹å§‹æ™‚ã®ç‚¹æ•°</label><select class="filter-control" id="scoreSelect" onchange="applyFilters()"><option value="">ã™ã¹ã¦</option></select></div>
</div>
<div id="periodInfo" class="period-info"></div>
<div class="stats" id="statsArea"></div>
<div class="rankings">
<div class="ranking-section"><div class="ranking-title up">ğŸ“ˆ ä¸Šæ˜‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="upList"></div></div>
<div class="ranking-section"><div class="ranking-title down">ğŸ“‰ ä¸‹é™ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="downList"></div></div>
</div>
</div>
<div id="graph-content" class="tab-content">
<div class="filters">
<div class="filter-group"><label class="filter-label">åº—åã§æ¤œç´¢</label><input type="text" class="filter-control" id="graphSearchBox" placeholder="åº—åã‚’å…¥åŠ›..." oninput="updateGraphFilters()"></div>
<div class="filter-group"><label class="filter-label">çœŒ</label><select class="filter-control" id="graphPrefectureSelect" onchange="updateGraphFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ä¾¡æ ¼å¸¯</label><select class="filter-control" id="graphPriceSelect" onchange="updateGraphFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ã‚¸ãƒ£ãƒ³ãƒ«</label><select class="filter-control" id="graphGenreSelect" onchange="updateGraphFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">é–‹å§‹æ™‚ã®ç‚¹æ•°</label><select class="filter-control" id="graphScoreSelect" onchange="updateGraphFilters()"><option value="">ã™ã¹ã¦</option></select></div>
</div>
<div class="canvas-container"><canvas id="mainChart"></canvas></div>
<div class="legend" id="legendArea"></div>
</div>
<div id="spike-content" class="tab-content">
<div class="filters">
<div class="filter-group"><label class="filter-label">åº—åã§æ¤œç´¢</label><input type="text" class="filter-control" id="spikeSearchBox" placeholder="åº—åã‚’å…¥åŠ›..." oninput="applySpikeFilters()"></div>
<div class="filter-group"><label class="filter-label">çœŒ</label><select class="filter-control" id="spikePrefectureSelect" onchange="applySpikeFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ä¾¡æ ¼å¸¯</label><select class="filter-control" id="spikePriceSelect" onchange="applySpikeFilters()"><option value="">ã™ã¹ã¦</option></select></div>
<div class="filter-group"><label class="filter-label">ã‚¸ãƒ£ãƒ³ãƒ«</label><select class="filter-control" id="spikeGenreSelect" onchange="applySpikeFilters()"><option value="">ã™ã¹ã¦</option></select></div>
</div>
<div class="period-info">å…¨æœŸé–“ã®æœ€å¤§å˜æœˆå¤‰å‹•ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
<div class="stats" id="spikeStatsArea"></div>
<div class="rankings">
<div class="ranking-section"><div class="ranking-title up">âš¡ æ€¥ä¸Šæ˜‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="spikeUpList"></div></div>
<div class="ranking-section"><div class="ranking-title down">âš¡ æ€¥é™ä¸‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div><div id="spikeDownList"></div></div>
</div>
</div>
</div>
</div>
</div>
<script>
var storeData = [];
var filteredRankingData = [];
var filteredGraphData = [];
var filteredSpikeData = [];
var chartInstance = null;
var chartColors = ['#667eea','#10b981','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#84cc16','#f97316','#ec4899','#14b8a6','#6366f1','#d946ef','#f43f5e'];

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function normalizeDate(dateStr) {
    if (!dateStr) return dateStr;
    var match = dateStr.match(/^(\d{4})[-\/]?(\d{1,2})$/);
    if (match) {
        return match[1] + '-' + match[2].padStart(2, '0');
    }
    return dateStr;
}

function analyzeData(data) {
    var groups = {};
    
    data.forEach(function(row) {
        var id = row['åº—èˆ—ID'];
        var name = row['åº—å'];
        var score = parseFloat(row['ç‚¹æ•°']);
        var date = normalizeDate(row['å¹´æœˆ']);
        var genre = row['ã‚¸ãƒ£ãƒ³ãƒ«å'] || '';
        var reviewCount = parseInt(row['å£ã‚³ãƒŸæ•°']) || 0;
        var scoreDiff = parseFloat(row['ç‚¹æ•°å·®åˆ†']) || 0;
        
        if (id && name && !isNaN(score) && date) {
            if (!groups[id]) {
                groups[id] = {
                    data: [],
                    genres: new Set(),
                    name: name,
                    prefecture: row['çœŒ'] || 'ä¸æ˜',
                    priceRange: row['ä¾¡æ ¼å¸¯'] || 'ä¸æ˜',
                    maxPositiveDiff: 0,
                    maxNegativeDiff: 0,
                    maxPositiveMonth: '',
                    maxNegativeMonth: ''
                };
            }
            
            groups[id].data.push({
                id: id,
                name: name,
                score: score,
                date: date,
                reviewCount: reviewCount,
                scoreDiff: scoreDiff
            });
            
            if (genre) groups[id].genres.add(genre);
            
            if (scoreDiff > groups[id].maxPositiveDiff) {
                groups[id].maxPositiveDiff = scoreDiff;
                groups[id].maxPositiveMonth = date;
            }
            if (scoreDiff < groups[id].maxNegativeDiff) {
                groups[id].maxNegativeDiff = scoreDiff;
                groups[id].maxNegativeMonth = date;
            }
        }
    });

    var results = [];
    Object.keys(groups).forEach(function(id) {
        var group = groups[id];
        var stores = group.data;
        
        if (stores.length >= 1) {
            stores.sort(function(a, b) {
                return a.date.localeCompare(b.date);
            });
            var first = stores[0];
            var last = stores[stores.length - 1];
            var diff = stores.length > 1 ? last.score - first.score : 0;
            
            var genreArray = Array.from(group.genres).filter(function(g) { return g; });
            var genreDisplay = genreArray.length > 0 ? genreArray.join(' / ') : 'ä¸æ˜';
            
            results.push({
                id: id,
                name: group.name,
                prefecture: group.prefecture,
                genre: genreDisplay,
                priceRange: group.priceRange,
                startScore: first.score,
                endScore: last.score,
                currentReviewCount: last.reviewCount,
                diff: Math.round(diff * 100) / 100,
                startDate: first.date,
                endDate: last.date,
                timeSeries: stores,
                maxPositiveDiff: Math.round(group.maxPositiveDiff * 100) / 100,
                maxNegativeDiff: Math.round(group.maxNegativeDiff * 100) / 100,
                maxPositiveMonth: group.maxPositiveMonth,
                maxNegativeMonth: group.maxNegativeMonth
            });
        }
    });
    
    results.sort(function(a, b) {
        return b.diff - a.diff;
    });
    return results;
}

function displayResults(data) {
    storeData = data;
    filteredRankingData = data;
    filteredGraphData = data;
    filteredSpikeData = data;
    document.getElementById('results').classList.remove('hidden');
    setupFilters();
    updateStats();
    displayRanking();
}

function setupFilters() {
    var prefectures = Array.from(new Set(storeData.map(function(s) { return s.prefecture; }))).sort();
    var priceRanges = Array.from(new Set(storeData.map(function(s) { return s.priceRange; }))).filter(function(p) { return p !== 'ä¸æ˜'; }).sort(function(a, b) {
        var aNum = parseInt(a.replace(/[^\d]/g, '')) || 0;
        var bNum = parseInt(b.replace(/[^\d]/g, '')) || 0;
        return aNum - bNum;
    });
    
    var genresSet = new Set();
    storeData.forEach(function(store) {
        var genres = store.genre.split('/').map(function(g) { return g.trim(); }).filter(function(g) { return g && g !== 'ä¸æ˜'; });
        genres.forEach(function(g) { genresSet.add(g); });
    });
    var genres = Array.from(genresSet).sort();
    
    var startScores = [];
    for (var i = 30; i <= 50; i++) {
        startScores.push((i / 10).toFixed(1) + 'å°');
    }
    
    function populateSelect(selectId, options) {
        var select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
            options.forEach(function(option) {
                select.innerHTML += '<option value="' + escapeHtml(option) + '">' + escapeHtml(option) + '</option>';
            });
        }
    }
    
    ['', 'graph', 'spike'].forEach(function(prefix) {
        var pre = prefix ? prefix.charAt(0).toUpperCase() + prefix.slice(1) : '';
        populateSelect(prefix + (prefix ? 'P' : 'p') + 'refectureSelect', prefectures);
        populateSelect(prefix + (prefix ? 'P' : 'p') + 'riceSelect', priceRanges);
        populateSelect(prefix + (prefix ? 'G' : 'g') + 'enreSelect', genres);
        if (prefix !== 'spike') {
            populateSelect(prefix + (prefix ? 'S' : 's') + 'coreSelect', startScores);
        }
    });
}

function applyFilters() {
    var searchTerm = document.getElementById('searchBox').value.toLowerCase();
    var prefecture = document.getElementById('prefectureSelect').value;
    var priceRange = document.getElementById('priceSelect').value;
    var genre = document.getElementById('genreSelect').value;
    var startScore = document.getElementById('scoreSelect').value;
    
    filteredRankingData = storeData.filter(function(store) {
        if (searchTerm && !store.name.toLowerCase().includes(searchTerm)) return false;
        if (prefecture && store.prefecture !== prefecture) return false;
        if (priceRange && store.priceRange !== priceRange) return false;
        if (genre && !store.genre.includes(genre)) return false;
        if (startScore) {
            var scoreRange = parseFloat(startScore.replace('å°', ''));
            if (store.startScore < scoreRange || store.startScore >= scoreRange + 0.1) return false;
        }
        return true;
    });
    
    updateStats();
    displayRanking();
}

function updateGraphFilters() {
    var searchTerm = document.getElementById('graphSearchBox').value.toLowerCase();
    var prefecture = document.getElementById('graphPrefectureSelect').value;
    var priceRange = document.getElementById('graphPriceSelect').value;
    var genre = document.getElementById('graphGenreSelect').value;
    var startScore = document.getElementById('graphScoreSelect').value;
    
    filteredGraphData = storeData.filter(function(store) {
        if (searchTerm && !store.name.toLowerCase().includes(searchTerm)) return false;
        if (prefecture && store.prefecture !== prefecture) return false;
        if (priceRange && store.priceRange !== priceRange) return false;
        if (genre && !store.genre.includes(genre)) return false;
        if (startScore) {
            var scoreRange = parseFloat(startScore.replace('å°', ''));
            if (store.startScore < scoreRange || store.startScore >= scoreRange + 0.1) return false;
        }
        return true;
    });
    
    drawTimeSeries();
}

function applySpikeFilters() {
    var searchTerm = document.getElementById('spikeSearchBox').value.toLowerCase();
    var prefecture = document.getElementById('spikePrefectureSelect').value;
    var priceRange = document.getElementById('spikePriceSelect').value;
    var genre = document.getElementById('spikeGenreSelect').value;
    
    filteredSpikeData = storeData.filter(function(store) {
        if (searchTerm && !store.name.toLowerCase().includes(searchTerm)) return false;
        if (prefecture && store.prefecture !== prefecture) return false;
        if (priceRange && store.priceRange !== priceRange) return false;
        if (genre && !store.genre.includes(genre)) return false;
        return true;
    });
    
    updateSpikeStats();
    displaySpikeRanking();
}

function updateStats() {
    var data = filteredRankingData;
    var improved = data.filter(function(s) { return s.diff > 0; }).length;
    var worsened = data.filter(function(s) { return s.diff < 0; }).length;
    var unchanged = data.filter(function(s) { return s.diff === 0; }).length;
    
    var startDate = '';
    var endDate = '';
    if (data.length > 0) {
        var allStartDates = data.map(function(s) { return s.startDate; }).filter(function(d) { return d; });
        var allEndDates = data.map(function(s) { return s.endDate; }).filter(function(d) { return d; });
        if (allStartDates.length > 0) {
            startDate = allStartDates.sort()[0];
            endDate = allEndDates.sort().reverse()[0];
        }
    }
    
    if (startDate && endDate) {
        document.getElementById('periodInfo').textContent = startDate + ' ã€œ ' + endDate + ' ã®é›†è¨ˆçµæœ';
    }
    
    document.getElementById('statsArea').innerHTML = 
        '<div class="stat-card"><div class="stat-number" style="color:#667eea;">' + data.length + '</div><div class="stat-label">ç·åº—èˆ—æ•°</div></div>' +
        '<div class="stat-card"><div class="stat-number" style="color:#10b981;">' + improved + '</div><div class="stat-label">è¦³æ¸¬é–‹å§‹æ™‚ã‚ˆã‚Šä¸Šæ˜‡</div></div>' +
        '<div class="stat-card"><div class="stat-number" style="color:#ef4444;">' + worsened + '</div><div class="stat-label">è¦³æ¸¬é–‹å§‹æ™‚ã‚ˆã‚Šä¸‹é™</div></div>' +
        '<div class="stat-card"><div class="stat-number" style="color:#64748b;">' + unchanged + '</div><div class="stat-label">è¦³æ¸¬é–‹å§‹æ™‚ã¨å¤‰å‹•ãªã—</div></div>';
}

function displayRanking() {
    var upStores = filteredRankingData.filter(function(s) { return s.diff > 0; });
    var downStores = filteredRankingData.filter(function(s) { return s.diff < 0; }).sort(function(a, b) { return a.diff - b.diff; });
    
    function createRankingHtml(stores, type) {
        if (stores.length === 0) return '<div class="empty-state">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        
        return stores.map(function(store, index) {
            var scoreText = type === 'up' ? '+' + store.diff : store.diff;
            var scoreClass = type === 'up' ? 'positive' : 'negative';
            
            return '<div class="ranking-item ' + type + '">' +
                '<div>' +
                '<div class="store-name">' + (index + 1) + '. ' + escapeHtml(store.name) + '</div>' +
                '<div class="store-details">' +
                escapeHtml(store.prefecture) + ' | ' + escapeHtml(store.genre) + ' | ' + escapeHtml(store.priceRange) +
                '<br>' + store.startScore + ' â†’ ' + store.endScore + ' (' + store.startDate + 'ã€œ' + store.endDate + ')' +
                '<br>å£ã‚³ãƒŸæ•°: ' + store.currentReviewCount + 'ä»¶' +
                '</div>' +
                '</div>' +
                '<div class="score-change ' + scoreClass + '">' + scoreText + '</div>' +
                '</div>';
        }).join('');
    }
    
    document.getElementById('upList').innerHTML = createRankingHtml(upStores, 'up');
    document.getElementById('downList').innerHTML = createRankingHtml(downStores, 'down');
}

function updateSpikeStats() {
    var data = filteredSpikeData;
    var positive = data.filter(function(s) { return s.maxPositiveDiff > 0; }).length;
    var negative = data.filter(function(s) { return s.maxNegativeDiff < 0; }).length;
    
    document.getElementById('spikeStatsArea').innerHTML = 
        '<div class="stat-card"><div class="stat-number" style="color:#667eea;">' + data.length + '</div><div class="stat-label">ç·åº—èˆ—æ•°</div></div>' +
        '<div class="stat-card"><div class="stat-number" style="color:#10b981;">' + positive + '</div><div class="stat-label">ä¸Šæ˜‡è¨˜éŒ²ã‚ã‚Š</div></div>' +
        '<div class="stat-card"><div class="stat-number" style="color:#ef4444;">' + negative + '</div><div class="stat-label">ä¸‹é™è¨˜éŒ²ã‚ã‚Š</div></div>';
}

function displaySpikeRanking() {
    var upStores = filteredSpikeData.filter(function(s) { return s.maxPositiveDiff > 0; }).sort(function(a, b) { return b.maxPositiveDiff - a.maxPositiveDiff; });
    var downStores = filteredSpikeData.filter(function(s) { return s.maxNegativeDiff < 0; }).sort(function(a, b) { return a.maxNegativeDiff - b.maxNegativeDiff; });
    
    function createSpikeRankingHtml(stores, type) {
        if (stores.length === 0) return '<div class="empty-state">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
        
        return stores.map(function(store, index) {
            var scoreText, scoreClass, monthText;
            if (type === 'up') {
                scoreText = '+' + store.maxPositiveDiff;
                scoreClass = 'positive';
                monthText = store.maxPositiveMonth;
            } else {
                scoreText = store.maxNegativeDiff;
                scoreClass = 'negative';
                monthText = store.maxNegativeMonth;
            }
            
            return '<div class="ranking-item ' + type + '">' +
                '<div>' +
                '<div class="store-name">' + (index + 1) + '. ' + escapeHtml(store.name) + '</div>' +
                '<div class="store-details">' +
                escapeHtml(store.prefecture) + ' | ' + escapeHtml(store.genre) + ' | ' + escapeHtml(store.priceRange) +
                '<br>æœ€å¤§å¤‰å‹•æœˆ: ' + monthText +
                '<br>å£ã‚³ãƒŸæ•°: ' + store.currentReviewCount + 'ä»¶' +
                '</div>' +
                '</div>' +
                '<div class="score-change ' + scoreClass + '">' + scoreText + '</div>' +
                '</div>';
        }).join('');
    }
    
    document.getElementById('spikeUpList').innerHTML = createSpikeRankingHtml(upStores, 'up');
    document.getElementById('spikeDownList').innerHTML = createSpikeRankingHtml(downStores, 'down');
}

function drawTimeSeries() {
    var canvas = document.getElementById('mainChart');
    if (!canvas) return;
    
    if (chartInstance) chartInstance.destroy();
    
    var validStores = filteredGraphData.filter(function(store) {
        return store.timeSeries && store.timeSeries.length > 1;
    });
    
    if (validStores.length === 0) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#64748b';
        ctx.font = '18px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    var allDatesSet = new Set();
    validStores.forEach(function(store) {
        store.timeSeries.forEach(function(point) {
            allDatesSet.add(point.date);
        });
    });
    allDatesSet.add('2023-09');
    
    var uniqueDates = Array.from(allDatesSet).sort();
    if (uniqueDates.length === 0) return;
    
    var datasets = validStores.map(function(store, index) {
        var color = chartColors[index % chartColors.length];
        var dataPoints = uniqueDates.map(function(date) {
            var point = store.timeSeries.find(function(p) { return p.date === date; });
            return point ? point.score : null;
        });
        
        return {
            label: store.name,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            tension: 0.1,
            spanGaps: true
        };
    });
    
    var ctx = canvas.getContext('2d');
    var originalColors = datasets.map(function(ds) { return ds.borderColor; });
    var lastHoveredIndex = -1;
    
    function resetAllLines() {
        if (chartInstance && lastHoveredIndex !== -1) {
            lastHoveredIndex = -1;
            chartInstance.data.datasets.forEach(function(dataset, index) {
                dataset.borderColor = originalColors[index];
                dataset.borderWidth = 2;
                dataset.pointRadius = 0;
                dataset.pointHoverRadius = 6;
            });
            chartInstance.update('none');
        }
    }
    
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: uniqueDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                intersect: false
            },
            onHover: function(event, activeElements) {
                if (activeElements.length > 0) {
                    var hoveredIndex = activeElements[0].datasetIndex;
                    
                    if (hoveredIndex !== lastHoveredIndex) {
                        lastHoveredIndex = hoveredIndex;
                        
                        chartInstance.data.datasets.forEach(function(dataset, index) {
                            if (index === hoveredIndex) {
                                dataset.borderColor = originalColors[index];
                                dataset.borderWidth = 4;
                                dataset.pointRadius = 4;
                                dataset.pointHoverRadius = 7;
                            } else {
                                dataset.borderColor = 'rgba(200, 200, 200, 0.3)';
                                dataset.borderWidth = 1;
                                dataset.pointRadius = 0;
                                dataset.pointHoverRadius = 0;
                            }
                        });
                        
                        chartInstance.update('none');
                    }
                } else {
                    resetAllLines();
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'å¹´æœˆ',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: false
                    },
                    grid: {
                        display: true,
                        color: '#f3f4f6'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'è©•ä¾¡ç‚¹æ•°',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    min: 3.0,
                    max: 3.72,
                    ticks: {
                        stepSize: 0.02,
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    },
                    grid: {
                        display: true,
                        color: function(context) {
                            var value = context.tick.value;
                            var remainder = Math.round((value % 0.1) * 100) / 100;
                            if (Math.abs(remainder) < 0.001 || Math.abs(remainder - 0.1) < 0.001) return '#9ca3af';
                            if (Math.abs(remainder - 0.05) < 0.001) return '#d1d5db';
                            return '#f3f4f6';
                        },
                        lineWidth: function(context) {
                            var value = context.tick.value;
                            var remainder = Math.round((value % 0.1) * 100) / 100;
                            if (Math.abs(remainder) < 0.001 || Math.abs(remainder - 0.1) < 0.001) return 1.5;
                            if (Math.abs(remainder - 0.05) < 0.001) return 1;
                            return 0.5;
                        }
                    }
                }
            }
        }
    });
    
    canvas.addEventListener('mouseleave', resetAllLines);
    canvas.addEventListener('mouseout', resetAllLines);
    
    var legendHtml = validStores.map(function(store, index) {
        var color = chartColors[index % chartColors.length];
        var displayName = store.name.length > 25 ? store.name.substring(0, 25) + '...' : store.name;
        return '<div class="legend-item"><div class="legend-color" style="background:' + color + ';"></div>' + escapeHtml(displayName) + '</div>';
    }).join('');
    
    document.getElementById('legendArea').innerHTML = legendHtml;
}

function switchTab(tabName) {
    var tabs = document.querySelectorAll('.tab');
    var tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(function(t) { t.classList.remove('active'); });
    tabContents.forEach(function(c) { c.classList.remove('active'); });
    
    if (tabName === 'ranking') {
        document.querySelector('.tab[onclick="switchTab(\'ranking\')"]').classList.add('active');
        document.getElementById('ranking-content').classList.add('active');
    } else if (tabName === 'graph') {
        document.querySelector('.tab[onclick="switchTab(\'graph\')"]').classList.add('active');
        document.getElementById('graph-content').classList.add('active');
        if (storeData.length > 0) updateGraphFilters();
    } else if (tabName === 'spike') {
        document.querySelector('.tab[onclick="switchTab(\'spike\')"]').classList.add('active');
        document.getElementById('spike-content').classList.add('active');
        if (storeData.length > 0) applySpikeFilters();
    }
}

function handleFileUpload(file) {
    if (!file || !file.name.toLowerCase().endsWith('.csv')) {
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    Papa.parse(file, {
        header: true,
        complete: function(results) {
            try {
                var analyzed = analyzeData(results.data);
                displayResults(analyzed);
            } catch (error) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error(error);
            }
        },
        error: function(error) {
            alert('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
    });
}

function loadSampleData() {
    var sampleCSV = 'åº—èˆ—ID,åº—å,çœŒ,ä¾¡æ ¼å¸¯,ã‚¸ãƒ£ãƒ³ãƒ«å,ç‚¹æ•°,å¹´æœˆ,å£ã‚³ãƒŸæ•°,ç‚¹æ•°å·®åˆ†\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.45,2023-09,120,0\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.48,2023-10,135,0.03\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.52,2023-11,148,0.04\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.55,2023-12,162,0.03\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.58,2024-01,178,0.03\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.61,2024-02,195,0.03\n' +
        '001,ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ¡œ,æ±äº¬éƒ½,3000å††ï½4000å††,ã‚¤ã‚¿ãƒªã‚¢ãƒ³,3.64,2024-03,210,0.03\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.62,2023-09,89,0\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.59,2023-10,92,-0.03\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.56,2023-11,95,-0.03\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.54,2023-12,98,-0.02\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.52,2024-01,101,-0.02\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.50,2024-02,104,-0.02\n' +
        '002,å¯¿å¸å‡¦æµ·æœˆ,å¤§é˜ªåºœ,5000å††ï½6000å††,å¯¿å¸,3.48,2024-03,107,-0.02\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.25,2023-09,205,0\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.28,2023-10,218,0.03\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.32,2023-11,232,0.04\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.36,2023-12,245,0.04\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.40,2024-01,260,0.04\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.43,2024-02,275,0.03\n' +
        '003,ã‚«ãƒ•ã‚§é¢¨èŠ±,ç¥å¥ˆå·çœŒ,1000å††ï½2000å††,ã‚«ãƒ•ã‚§,3.46,2024-03,290,0.03';
    
    Papa.parse(sampleCSV, {
        header: true,
        complete: function(results) {
            var analyzed = analyzeData(results.data);
            displayResults(analyzed);
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    var fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
});
</script>
</body>
</html>
